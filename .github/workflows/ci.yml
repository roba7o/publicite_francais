name: CI

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  # Fast tests without database
  test-unit:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.12]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]

    - name: Run code quality checks
      run: |
        python -m ruff format src
        python -m ruff check --fix src

    - name: Run essential tests (no database)
      run: |
        PYTHONPATH=src python -m pytest tests/test_essential.py -v

  # Integration tests with database
  test-integration:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: ci_test_password_123
          POSTGRES_USER: ci_test_user
          POSTGRES_DB: french_news_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: 3.12

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]

    - name: Set up test database schema
      run: |
        PGPASSWORD=ci_test_password_123 psql -h localhost -U ci_test_user -d french_news_test -f database/test_schema.sql

    - name: Run integration tests (database + scraper, no dbt)
      env:
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        POSTGRES_DB: french_news_test
        POSTGRES_USER: ci_test_user
        POSTGRES_PASSWORD: ci_test_password_123
        DATABASE_ENV: test
        DEBUG: true
        OFFLINE: true
      run: |
        PYTHONPATH=src python -m pytest tests/test_database_connection.py tests/test_deterministic_pipeline.py::TestDeterministicPipeline::test_html_file_counts tests/test_deterministic_pipeline.py::TestDeterministicPipeline::test_database_article_extraction -v


